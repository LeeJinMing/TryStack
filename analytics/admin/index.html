<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TryStack Analytics（Admin）</title>
    <style>
      body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; background: #f6f7f9; color: #111827; }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
      h1 { margin: 0 0 6px; font-size: 22px; }
      .muted { color: #6b7280; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-top: 12px; }
      .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 14px; }
      .kpi { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
      .kpi .card b { font-size: 20px; display: block; margin-top: 6px; }
      @media (max-width: 900px) { .kpi { grid-template-columns: 1fr; } }
      table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; overflow: hidden; }
      th, td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; text-align: left; font-size: 13px; }
      th { background: #f8fafc; }
      .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      @media (max-width: 900px) { .grid2 { grid-template-columns: 1fr; } }
      .err { color: #7f1d1d; }
      .btn { display: inline-flex; align-items: center; justify-content: center; padding: 8px 12px; border-radius: 999px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer; font-weight: 600; }
      select { padding: 8px 12px; border-radius: 10px; border: 1px solid #e5e7eb; background: #fff; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>TryStack Analytics（Admin）</h1>
      <div class="muted">中文简表。数据来自 <code>/api/stats</code>（Vercel + KV）。</div>

      <div class="row">
        <label class="muted">时间范围</label>
        <select id="days">
          <option value="1">今天（1 天）</option>
          <option value="7" selected>近 7 天</option>
          <option value="14">近 14 天</option>
          <option value="30">近 30 天</option>
        </select>
        <button id="refresh" class="btn" type="button">刷新</button>
        <span id="status" class="muted"></span>
      </div>

      <div class="kpi" style="margin-top: 12px;">
        <div class="card"><div class="muted">访问（page_view）</div><b id="kpi_pv">-</b></div>
        <div class="card"><div class="muted">复制命令（copy_command）</div><b id="kpi_copy">-</b></div>
        <div class="card"><div class="muted">下载脚本（download_script）</div><b id="kpi_dl">-</b></div>
      </div>

      <div class="grid2" style="margin-top: 12px;">
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px;">Top repos（近似兴趣）</div>
          <div id="topRepos" class="muted">-</div>
        </div>
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px;">Top not found（想试但没 recipe）</div>
          <div id="topNotFound" class="muted">-</div>
        </div>
      </div>

      <div style="margin-top: 12px;">
        <div class="muted" style="margin: 8px 0;">按天统计（事件计数）</div>
        <div id="tableWrap"></div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const fmt = (n) => (typeof n === "number" ? n.toLocaleString("zh-CN") : "-");

      function renderTop(list) {
        if (!Array.isArray(list) || list.length === 0) return "<div class='muted'>暂无</div>";
        return "<table><thead><tr><th>repo</th><th>次数</th></tr></thead><tbody>" +
          list.map((x) => `<tr><td><code>${String(x.repo || "")}</code></td><td>${fmt(Number(x.count || 0))}</td></tr>`).join("") +
          "</tbody></table>";
      }

      function renderDaily(days) {
        if (!Array.isArray(days) || days.length === 0) return "<div class='muted'>暂无</div>";
        const keys = Object.keys(days[0].events || {});
        const head = "<tr><th>日期</th>" + keys.map((k) => `<th>${k}</th>`).join("") + "</tr>";
        const rows = days.map((d) => {
          const tds = keys.map((k) => `<td>${fmt(Number(d.events?.[k] || 0))}</td>`).join("");
          return `<tr><td><code>${d.day}</code></td>${tds}</tr>`;
        }).join("");
        return `<table><thead>${head}</thead><tbody>${rows}</tbody></table>`;
      }

      async function load() {
        const days = Number($("days").value || 7);
        $("status").textContent = "加载中…";
        try {
          const res = await fetch(`/api/stats?days=${days}`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          const totals = data.totals || {};
          $("kpi_pv").textContent = fmt(Number(totals.page_view || 0));
          $("kpi_copy").textContent = fmt(Number(totals.copy_command || 0));
          $("kpi_dl").textContent = fmt(Number(totals.download_script || 0));
          $("topRepos").innerHTML = renderTop(data.topRepos);
          $("topNotFound").innerHTML = renderTop(data.topNotFound);
          $("tableWrap").innerHTML = renderDaily(data.days);
          $("status").textContent = "OK";
        } catch (e) {
          $("status").innerHTML = `<span class="err">失败：${String(e.message || e)}</span>`;
        }
      }

      $("refresh").addEventListener("click", load);
      $("days").addEventListener("change", load);
      load();
    </script>
  </body>
</html>

